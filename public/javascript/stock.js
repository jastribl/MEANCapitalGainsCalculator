// Generated by CoffeeScript 1.9.3
(function() {
  var stockApp;

  stockApp = angular.module('stockApp', []);

  stockApp.controller('StockController', function($scope, $http) {
    var i, j, ref, resetError, resetForm, resetNewEntry, results, results1, updateEntriesList;
    $scope.editId = null;
    $scope.years = (function() {
      results = [];
      for (var i = 2000, ref = new Date().getFullYear() + 1; 2000 <= ref ? i <= ref : i >= ref; 2000 <= ref ? i++ : i--){ results.push(i); }
      return results;
    }).apply(this);
    $scope.months = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
    $scope.days = (function() {
      results1 = [];
      for (j = 1; j <= 31; j++){ results1.push(j); }
      return results1;
    }).apply(this);
    updateEntriesList = function() {
      return $http.get('/api/entriesList?stockName=' + $scope.stockName).then(function(entriesList) {
        return $scope.entriesList = entriesList.data;
      });
    };
    resetNewEntry = function() {
      return $scope.newEntry = {
        stockName: $scope.stockName,
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1,
        day: new Date().getDate(),
        tradeNumber: 1,
        buysell: 'buy',
        price: null,
        commission: 9.99
      };
    };
    resetError = function() {
      return $scope.error = null;
    };
    resetForm = function() {
      return updateEntriesList().then(function() {
        resetNewEntry();
        resetError();
        $scope.adjustTradeNumber();
        return document.getElementById('newEntryAutofocusElement').focus();
      });
    };
    $scope.adjustTradeNumber = function() {
      var conflictEntries, k, len, ref1, testEntry;
      conflictEntries = [];
      ref1 = $scope.entriesList;
      for (k = 0, len = ref1.length; k < len; k++) {
        testEntry = ref1[k];
        if (testEntry.year === $scope.newEntry.year && testEntry.month === $scope.newEntry.month && testEntry.day === $scope.newEntry.day) {
          conflictEntries.push(testEntry.tradeNumber);
        } else if (testEntry.year > $scope.newEntry.year && testEntry.month > $scope.newEntry.month && testEntry.day > $scope.newEntry.day) {
          if (conflictEntries.length === 0 || conflictEntries.indexOf($scope.newEntry.tradeNumber) === -1) {
            return;
          }
          break;
        }
      }
      while (true) {
        if (conflictEntries.indexOf($scope.newEntry.tradeNumber) === -1) {
          break;
        }
        $scope.newEntry.tradeNumber++;
      }
    };
    $scope.add = function() {
      return $http.post('/api/entriesList?entry=' + JSON.stringify($scope.newEntry)).then(function() {
        return resetForm();
      });
    };
    $scope.remove = function(_id) {
      return $http["delete"]('/api/entriesList?_id=' + _id).then(function() {
        return updateEntriesList().then(function() {
          return $scope.adjustTradeNumber();
        });
      });
    };
    $scope.editMode = function(_id) {
      return console.log(_id);
    };
    $scope.edit = function(_id) {
      return console.log(_id);
    };
    return resetForm();
  });

}).call(this);
